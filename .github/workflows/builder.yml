name: GSI Builder (xz GSI)
permissions:
  contents: write
on:
  push:
    branches:
      - main  # Change this to your desired branch
  workflow_dispatch:
    inputs:
        GSI:
              description: 'GSI Link'
              required: true
        NAME:
              description: 'Tên ROM'
              required: true
        VERSION:
              description: 'Phiên bản Baseband'
              required: true
              default: 'A035FXXS9CYG1'
        VENDOR:
              description: 'Vendor Link'
              required: true
              default: 'https://sourceforge.net/projects/a035f/files/vendor.img'
jobs:
  Build:
    runs-on: ubuntu-latest

    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y zip xz-utils unzip p7zip-full wget
        
    - name: Installing Tools
      run: |
        git clone https://github.com/Exynos-nigg/lpunpack-lpmake-mirror.git lpbinary
        cd lpbinary
        bash install.sh
    - name: Downloading Your GSI And Extracting
      run: |
        cd lpbinary/binary
        wget ${{ github.event.inputs.GSI }}
        mkdir sys
        mv *.xz sys
        cd sys
        unxz *.xz
        mv *.img ../system.img
        cd ..
    - name: Preparing Files
      run: |
        cd lpbinary/binary
        wget ${{ github.event.inputs.VENDOR }}
        wget https://sourceforge.net/projects/a035f/files/product.img
        wget https://sourceforge.net/projects/a035f/files/system_ext.img
    - name: Packing
      run: |
        cd lpbinary/binary
        ./lpmake --metadata-size 65536 --super-name super --metadata-slots 2 --device super:6763315200 --group main:6761218048 --partition system:readonly:$(ls -nl system.img | awk '{print $5}'):main --image system=system.img --partition vendor:readonly:$(ls -nl vendor.img | awk '{print $5}'):main --image vendor=vendor.img --partition product:readonly:$(ls -nl product.img | awk '{print $5}'):main --image product=product.img --partition system_ext:readonly:$(ls -nl system_ext.img | awk '{print $5}'):main --image system_ext=system_ext.img --sparse --output super.img
    - name: Creating tar and compressing to 7z
      run: |
        cd lpbinary/binary
        tar -cvf super.tar super.img
        rm -rf super.img
        7z a ${{ github.event.inputs.NAME }} super.tar
        rm -rf super.tar
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: lpbinary/binary/${{ github.event.inputs.NAME }}
        name: ${{ github.event.inputs.NAME }}
        tag_name: ${{ github.run_id }}
        body: |
            Thiết bị: Samsung Galaxy A03
            Phiên bản: ${{ github.event.inputs.VERSION }}
            Tên ROM: ${{ github.event.inputs.NAME }}
            Flash bằng Odin
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
